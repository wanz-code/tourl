<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media → URL (Catbox) — Wanz Official</title>
  <meta name="description" content="Upload media lalu convert jadi URL (Catbox) via proxy serverless - Wanz Official" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0b1220; --card:#ffffff; --muted:#8892a6; --accent-start:#f58529; --accent-end:#8134af;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto;
      background: linear-gradient(135deg, rgba(248,250,252,0.03), rgba(3,7,18,0.6)), radial-gradient(600px 300px at 10% 10%, rgba(245,133,41,0.06),transparent 40%);
      display:flex; align-items:center; justify-content:center; padding:28px;
      color:#0b1220;
    }

    .wrap{width:100%; max-width:820px}
    header{display:flex; gap:12px; align-items:center; margin-bottom:18px}
    .logo {
      width:56px; height:56px; border-radius:12px;
      background: conic-gradient(from 120deg,var(--accent-start),#dd2a7b,#8134af,#515bd4);
      display:grid; place-items:center; color:white; font-weight:700; box-shadow:0 10px 30px rgba(2,6,23,.35)
    }
    h1{font-size:22px; margin:0}
    p.sub{margin:0; font-size:13px; color:var(--muted)}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(250,250,250,0.94));
      border-radius:16px; padding:18px; box-shadow:0 12px 40px rgba(2,6,23,.25);
      border:1px solid rgba(5,8,15,0.06);
    }

    .upload-area{border:2px dashed rgba(6,8,12,.06); border-radius:12px; padding:18px; display:flex; gap:18px; align-items:center}
    .upload-left{flex:1}
    .dropbox{display:flex; align-items:center; justify-content:center; gap:12px; padding:22px; border-radius:12px; background:linear-gradient(180deg, #fff, #fafafa); cursor:pointer; min-height:120px; text-align:center}
    .dropbox.drag{outline:3px dashed rgba(129,58,180,0.3); transform:translateY(-2px)}
    .dropbox img.preview{max-width:110px; max-height:90px; object-fit:cover; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .controls{display:flex; gap:10px; margin-top:12px; align-items:center}
    .btn{padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600; color:white; background:linear-gradient(90deg,var(--accent-start),var(--accent-end)); box-shadow:0 8px 18px rgba(129,58,180,.12)}
    .btn.ghost{background:transparent; color:var(--muted); box-shadow:none; border:1px solid rgba(2,6,23,.04)}
    .btn:disabled{opacity:.6; cursor:not-allowed; transform:none}

    .right{width:320px}
    .meta{background:#fff; border-radius:12px; padding:12px; border:1px solid #eef2f7}
    .meta h3{margin:0 0 8px 0}
    .meta p{margin:0; color:var(--muted); font-size:14px}

    .out{margin-top:14px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .linkbox{background:#0b1220;color:#fff;padding:8px 12px;border-radius:999px;font-weight:600}
    .small{font-size:13px; color:var(--muted)}

    .wm{margin-top:14px; text-align:center; font-size:13px; color:var(--muted)}

    /* spinner */
    .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,.9);border-right-color:transparent;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* result area */
    .result-card{margin-top:14px;background:#fff;border-radius:12px;padding:12px;border:1px solid #eef2f7}
    .result-row{display:flex; align-items:center; gap:10px; justify-content:space-between}
    .result-row .left{display:flex; gap:10px; align-items:center}
    .copy{padding:8px 10px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#fff;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}

    /* responsive */
    @media (max-width:880px){
      .upload-area{flex-direction:column}
      .right{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">IG</div>
      <div>
        <h1>Media → URL (Catbox)</h1>
        <p class="sub">Upload file, dapatkan link permanen. Proxy serverless mencegah CORS. © Wanz Official</p>
      </div>
    </header>

    <div class="card">
      <div class="upload-area">
        <div class="upload-left">
          <div id="dropbox" class="dropbox" tabindex="0">
            <div id="dropInner">
              <div style="font-size:18px;font-weight:700">Drag & Drop atau Klik untuk pilih file</div>
              <div class="small muted">(gambar, video, audio, dokumen — max tergantung limit serverless)</div>
            </div>
          </div>

          <div class="controls">
            <input id="fileInput" type="file" hidden />
            <button id="pickBtn" class="btn ghost">Pilih File</button>
            <button id="uploadBtn" class="btn" disabled>Upload <span id="upSpinner" style="margin-left:8px; display:none" class="spinner"></span></button>
            <button id="clearBtn" class="btn ghost" style="display:none">Hapus</button>
            <div class="small muted" style="margin-left:auto">Provider: <b>Catbox</b></div>
          </div>

          <div id="previewInfo" class="result-card" style="display:none; margin-top:12px">
            <div class="result-row">
              <div class="left">
                <img id="previewThumb" class="preview" style="display:none" alt="preview"/>
                <div>
                  <div id="fileName" style="font-weight:700">-</div>
                  <div class="muted" style="font-size:13px" id="fileMeta">-</div>
                </div>
              </div>
              <div id="fileSize" class="muted">-</div>
            </div>
          </div>
        </div>

        <div class="right">
          <div class="meta">
            <h3>Petunjuk</h3>
            <p class="small">1. Pilih file atau drag ke area. 2. Klik Upload. 3. Tunggu proses — tombol dikunci saat upload. 4. Salin link setelah selesai.</p>
            <hr style="border:none;height:1px;background:#eef2f7;margin:10px 0" />
            <p class="small"><b>Keamanan:</b> File diupload ke Catbox (publik). Pastikan tidak mengupload data sensitif.</p>
          </div>

          <div id="outBox" style="margin-top:12px">
            <!-- hasil akan muncul disini -->
          </div>
        </div>
      </div>

      <div class="wm">© Wanz Official</div>
    </div>
  </div>

  <script>
    // elements
    const dropbox = document.getElementById('dropbox');
    const fileInput = document.getElementById('fileInput');
    const pickBtn = document.getElementById('pickBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const previewInfo = document.getElementById('previewInfo');
    const previewThumb = document.getElementById('previewThumb');
    const fileNameEl = document.getElementById('fileName');
    const fileMeta = document.getElementById('fileMeta');
    const fileSizeEl = document.getElementById('fileSize');
    const upSpinner = document.getElementById('upSpinner');
    const outBox = document.getElementById('outBox');

    let chosenFile = null;

    // helpers
    function humanSize(bytes){
      if(bytes === 0) return '0 B';
      const units = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes)/Math.log(1024));
      return (bytes / Math.pow(1024,i)).toFixed(i?2:0) + ' ' + units[i];
    }

    function resetSelection(){
      chosenFile = null;
      previewInfo.style.display = 'none';
      previewThumb.style.display = 'none';
      clearBtn.style.display = 'none';
      uploadBtn.disabled = true;
      fileInput.value = '';
      outBox.innerHTML = '';
    }

    function showPreview(file){
      chosenFile = file;
      fileNameEl.textContent = file.name;
      fileMeta.textContent = file.type || 'Unknown type';
      fileSizeEl.textContent = humanSize(file.size);
      previewInfo.style.display = 'block';
      clearBtn.style.display = 'inline-block';
      uploadBtn.disabled = false;

      // preview image if image
      if(file.type && file.type.startsWith('image/')){
        const url = URL.createObjectURL(file);
        previewThumb.src = url;
        previewThumb.style.display = 'block';
      } else {
        previewThumb.style.display = 'none';
      }
    }

    // drag/drop
    ['dragenter','dragover'].forEach(ev=>{
      dropbox.addEventListener(ev, (e)=>{
        e.preventDefault(); e.stopPropagation();
        dropbox.classList.add('drag');
      });
    });
    ['dragleave','drop'].forEach(ev=>{
      dropbox.addEventListener(ev, (e)=>{
        e.preventDefault(); e.stopPropagation();
        dropbox.classList.remove('drag');
      });
    });
    dropbox.addEventListener('drop', (e)=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f) showPreview(f);
    });

    // click to pick
    pickBtn.addEventListener('click', ()=>fileInput.click());
    dropbox.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', ()=>{ if(fileInput.files[0]) showPreview(fileInput.files[0]); });

    clearBtn.addEventListener('click', resetSelection);

    // copy helper
    function copyToClipboard(text){
      navigator.clipboard?.writeText(text).then(()=>toast('Tersalin ke clipboard')).catch(()=>toast('Gagal salin'));
    }

    // toast
    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position='fixed';
      el.style.right='18px';
      el.style.bottom='18px';
      el.style.background='rgba(8,12,20,.95)';
      el.style.color='#fff';
      el.style.padding='10px 12px';
      el.style.borderRadius='10px';
      el.style.boxShadow='0 8px 20px rgba(2,6,23,.45)';
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),2600);
    }

    // upload
    uploadBtn.addEventListener('click', async ()=>{
      if(!chosenFile){ toast('Pilih file dulu.'); return; }
      uploadBtn.disabled = true;
      upSpinner.style.display = 'inline-block';
      pickBtn.disabled = true;
      clearBtn.disabled = true;

      try{
        const fd = new FormData();
        // field name we send is "file" (server will forward as fileToUpload to Catbox)
        fd.append('file', chosenFile, chosenFile.name);

        // POST to serverless proxy
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: fd
        });

        const json = await res.json();
        if(!res.ok){
          throw new Error(json?.error || json?.message || 'Upload gagal');
        }

        // expected: { status:200, url: 'https://files.catbox.moe/xxxxx' }
        const url = json?.url || json?.data || json?.result || null;
        // some proxies return plain text (catbox returns direct url text) - handle both
        let finalUrl = null;
        if(typeof url === 'string' && url.startsWith('http')) finalUrl = url;
        else if(typeof json === 'string' && json.startsWith('http')) finalUrl = json;
        else if(json?.status === 200 && json?.url) finalUrl = json.url;
        else if(json?.success && json?.url) finalUrl = json.url;

        // if server returned the direct catbox text in 'data' or 'result', try to find url using regex
        if(!finalUrl){
          const txt = JSON.stringify(json);
          const m = txt.match(/https?:\/\/[^\s"']+/);
          if(m) finalUrl = m[0];
        }

        if(!finalUrl){
          // fallback: respond data
          outBox.innerHTML = `<div class="result-card"><div class="muted">Response:</div><pre style="white-space:pre-wrap;font-size:13px">${escapeHtml(JSON.stringify(json, null, 2))}</pre></div>`;
          toast('Upload selesai — lihat response (tidak ada URL eksplisit)');
        } else {
          outBox.innerHTML = `
            <div class="result-card">
              <div style="display:flex;align-items:center;gap:8px">
                <div style="flex:1">
                  <div style="font-weight:700">${escapeHtml(chosenFile.name)}</div>
                  <div class="muted" style="font-size:13px">${humanSize(chosenFile.size)} • ${escapeHtml(chosenFile.type || '-')}</div>
                </div>
                <button class="copy" id="copyBtn">Salin</button>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <div class="linkbox" id="resultLink">${escapeHtml(finalUrl)}</div>
                <a class="btn ghost" href="${finalUrl}" target="_blank" rel="noopener">Buka</a>
              </div>
            </div>
          `;
          document.getElementById('copyBtn').addEventListener('click', ()=>copyToClipboard(finalUrl));
          toast('Upload sukses');
        }

      }catch(err){
        console.error(err);
        toast('Upload gagal: '+ (err.message||err));
      }finally{
        uploadBtn.disabled = false;
        upSpinner.style.display = 'none';
        pickBtn.disabled = false;
        clearBtn.disabled = false;
      }
    });

    // small escape HTML helper
    function escapeHtml(s){
      return String(s).replace(/[&<>"'`]/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"`":'&#96;' })[m]);
    }

    // init
    resetSelection();
  </script>
</body>
  </html>
